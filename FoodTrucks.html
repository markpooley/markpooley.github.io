<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iowa City Food Trucks</title>
    <link rel="stylesheet" href="stylesheets/app.css"/>
    <link rel="stylesheet" href="stylesheets/custom.css"/>

    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <script src="bower_components/modernizr/modernizr.js"></script>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
  </head>
  <body>
    <nav class="top-bar" data-topbar>
      <ul class="title-area">
        <li class="name"></li>
        <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
      </ul>
      <section class="top-bar-section">
        <ul class="right">
          <li><a href="index.html">Home</a></li>
          <li class="has-dropdown"><a href="#">Projects</a>
            <ul class="dropdown">
              <li class="active"><a href="FoodTrucks.html">Iowa City Food Trucks</a></li>
              <li><a href="DentalServiceAreas.html">Dental Service Areas</a></li>
            </ul>
          </li>
          <li><a href="#">Link</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </section>
    </nav>

  	<div class="row toppadding">
  		<div class="large-12 columns text-center">
  			<h2>Iowa City Food Truck Eligible Operation Areas</h2>
  			<p class="panel">Iowa City's recent passing of an expanded food truck ordinance (<a href="http://www.dailyiowan.com/2015/03/30/Metro/41524.html">story here</a>) is welcome news, but
  			where can food trucks legally operate? Moreover, what areas are most beneficial for them to operate?<br> <br> Mouse over the map and use the scroll wheel to zoom, click and hold to drag/pan around the map.</br></p>
      </div>

  	</div>
  	<div class="row" data-equalizer>
	   	<div class="large-2 columns" data-equalizer-watch>
        <div class="large-12 columns panel">
	   		  <h5 class="text-center">Legend</h5>
          <div class="large-12 columns bottomspace" style="background-color: rgba(78,78,78, 0.85);">
            <div class="text-center LegText has tip" data-tooltip aria-haspopup="true" style="color: rgb(255,255,255)" title  ="Areas in residential neighborhoods, within the downtown district, or within 150 feet of restaurant."> Prohibited Operation Areas</div>
          </div>
          <h6 class="text-center toppadding">Employment Density (Jobs/SqMi)</h6>
          <div class="large-12 columns " style="background-color: rgba(40,146,199,0.70);">
            <div class="text-center" style="color: rgb(72,72,72)"> &le; 20 </div>
          </div>
          <div class="large-12 columns " style="background-color: rgba(160,194,155,0.70);">
            <div class="text-center" style="color: rgb(72,72,72)"> 21 - 50</div>
          </div>
          <div class="large-12 columns " style="background-color: rgba(250,250,100,0.70);">
            <div class="text-center" style="color: rgb(72,72,72)">51-150 </div>
          </div>
          <div class="large-12 columns " style="background-color: rgba(250,141,52,0.70);">
            <div class="text-center" style="color: rgb(72,72,72)">151 - 500</div>
          </div>
          <div class="large-12 columns bottomspace" style="background-color: rgba(232,16,20,0.70);">
            <div class="text-center" style="color: rgb(72,72,72)">500+</div>
          </div>
      </div>
         <div class="large-12 columns panel" data-equalize>
          <p class="small">This project was done using publicly available data, python, ESRI arcmap, and the D3 javascript library. To learn how it was done click the "Learn more" text below</p>
          <h5 class="text-center"><a href="#process">Learn more</a></h5></div>
       	</div>
	   	<div class="large-10 columns" id="map" data-equalizer-watch></div>

   </div>

   <div class="row">
    <div class="large-12 columns text-center" id="process">
    </div>
    <div class="large-12 columns">
      <ul class="tabs" data-tab role="tablist">
       <li class="tab-title active" role="presentational"><a href="#Data1" role="tab" tabindex="0" aria-selected="true" controls="Data1">Obtaining the Data</a></li>
       <li class="tab-title" role="presentational"><a href="#Data2" role="tab" tabindex="0" aria-selected="true" controls="Data2">Processing the Data</a></li>
       <li class="tab-title" role="presentational"><a href="#Data3" role="tab" tabindex="0" aria-selected="true" controls="Data3">Spatial Analysis of Data</a></li>
       <li class="tab-title" role="presentational"><a href="#Data4" role="tab" tabindex="0" aria-selected="true" controls="Data4">Displaying on the web</a></li>
      </ul>
      <div class="tabs-content">
        <section role="tabpanel" aria-hidden="false" class="content active" id="Data1">
          <h3> Finding data to get the proces started</h3><hr>
          <p>Iowa City is slated to expand food truck operations through a new city ordinance that will
          hopefully be adopted (<a href="http://www.dailyiowan.com/2015/03/30/Metro/41524.html">story</a>).But, the question is where can food trucks operate safely given these new guidlines? </p>
          <p>First, a directory/list of restaurants in Iowa City was needed (<a href="http://www.iowacitymenus.com/">Found here</a>),since foodtrucks are prohibited from operating within 150 feet of a restaurant. This list doesn't include KFC, McDonalds, or similar type estblishments.</p>
          <p>City boundary files were also needed to geofence the analysis to Iowa City (University Heights was included as well). A Statewide of shapefile of incorporated cities can be found <a href="https://programs.iowadnr.gov/nrgislibx/">here</a>. Using a simple query, Iowa City and University heights can be pulled out of the data.</p>
          <p><a class="clearing-thumbs th right" data-reveal-id="OnMap" href="Images/OnTheMap.png"><img src="Images/OnTheMapTh.png"></a>Finally, employment data can help inform where food trucks can optimally locate over the lunch hours. Nicely formatted data can be pulled within a geofenced area using <a href="http://onthemap.ces.census.gov/">OnTheMap</a></p>

          <div id="OnMap" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
            <img src="Images/OnTheMap.png">
            <p>Screenshot selecting the area for analysis</p>
            <a class="close-reveal-modal" aria-label="Close">&#215;</a>
          </div>
        </section>
        <section role="tabpanel" aria-hidden="true" class="content" id="Data2">
          <h3>Editing and pulling relevant data</h3><hr>
          <p>Addresses are needed for the geocoding of these locations, which can be obtained using python and the <a href="https://pypi.python.org/pypi/beautifulsoup4/4.3.2">Beautifulsoup</a> package to parse the html and write relevant information to a csv. Beeautiful soup can easily be installed with pip using <code>pip install BeautifulSoup</code>. The baked in <code>csv</code> and <code>urllib2</code> packages are also needed to get the process rolling.</p>
         <div class="large-12 columns bottomspace">
          <pre class="prettyprint">
            ########################
            #Import python modules
            ########################
            from BeautifulSoup import BeautifulSoup
            import urllib2
            import csv

            ##############################################################
            #Grab the url, open it and assign it to the variable "content"
            ##############################################################
            url = 'http://www.iowacitymenus.com/'
            page = urllib2.urlopen(url)
            content = urllib2.urlopen(url).read()

            #Assign soup variable to the cotent run through beuatifule soup
            #--------------------------------------------------------------
            soup = BeautifulSoup(content)

            #Create a dictionary variable and pull all the list elements from
            the soup content. The location/adresses were all found to be housed
            #within li tags.
            #----------------------------------------------------------------
            dict = {}
            locs = soup('li')

            ##############################################################
            #Create a CSV file where all the addresses will be written to.
            ##############################################################
            with open('ICEats.csv', 'wb') as csvfile:
                writer = csv.writer(csvfile, delimiter=',')
                writer.writerow(('Name','Address'))
                for loc in locs:
                    if loc.b == None:
                        pass
                    else:
                      #The addresses were in list elements, but housed within
                      #break elements makes pulling the necessary informaiton
                      #a bit difficult. So, some string manipulation was needed
                      #to get the needed info.
                      #---------------------------------------------------------
                        name = str(loc.b).strip('<>b/>')
                        line = str(loc)
                        s = line.find('br') + 5

                        place = line[s:]
                        e = place.find('br') - 1
                        place = place[:e]


                        dict[name] = place
                        writer.writerow((name,place))
            csvfile.close()
          </pre>
        </div>
          <p>With a csv of addresses (only a few of which required manual cleaning) the Google Geocoding API (nicely housed within <a href="https://github.com/DenisCarriere/geocoder">Denis Carriere's geocoder module</a>) can be used to obtain long/lat coordinates of each location, simply install using <code>pip install geocoder</code></p>
          <div class="large-12 columns bottomspace"><pre class="prettyprint">
            #######################
            Import python modules
            #######################
            mport geocoder
            mport time #needed to help prevent hitting the query limit
            mport csv
            mport arcpy

            #######################################################
            grab the table as input with empty lat and long fields
            #######################################################
            able = arcpy.GetParameterAsText(0)


            #############################################################
            Create a CSV file where all the addresses will be written to.
            #############################################################
            ith with arcpy.da.UpdateCursor(table,"*") as cursor:
             for row in cursor:
              #sleep .2 seconds to avoid hitting query limit of 5 request per second.
               timer.sleep(0.2)
               try:
                 #third column is the one with addresses, run it through the geocoder
                 loc = geocoder.google(row[2])
                 row[3] = loc.lat
                 row[4] = loc.lng
                 cursor.updateRow(row)
               except:
                 pass
          </pre></div>
        </section>
        <section role="tabpanel1" aria-hidden="true" class="content" id="Data3">
          <h3>Spatial analysis of the data</h3><hr>
          <p><a href="http://www.ESRI.com">ESRI ArcMap</a> was utilized to do the heavy lifting for analyzing the spatial data. The majority of the hang up was the fact that Iowa City lacks an overlay of zoning layers. Invidiual parcels are available with a zoning classificaiton, but this was less than ideal (for reaons that will become apparent shortly)</p>
          <h5>What was done in ArcMap</h5>
          <ul>
            <li>Create a 150 buffer around all restaurant locations </li>
            <li>Delineate the Downtown and Northside Districts</li>
            <li>Identify residential parcels and fill in road right of way areas</li>
            <li>Dissolve all the restricted areas into one feature</li>
            <li>Convert shapefiles to topojson for web display</li>
          </ul>
          <p>Creating a 150 buffer around restaurants is stratigh forward, and uses readily available geopcrocessing tools in ArcMap. The downtown districts were manually created using the <a href="http://www.icgov.org/site/CMSv2/File/planning/urban/ZoningMap.pdf">Iowa City Zoning Map</a> (warning, it's a HUGE PDF!)</p>
          <h5>Problems with parcels</h5>
          <p>A simple zoning overlay was all that was needed. However, only a parcel level shapefile was available. Parcels do not lend themselves to dissolving by zoning type well since all the of the road right&#45;of&#45;way is essentially empty.</p>
          <p>In order to get around this issue the road areas were isolated, and split using road centerline data (available <a href="http://www.iowadot.gov/gis/downloads/zipped_files/GIMS_History/2013/">here</a>).This data was merged with the parcel data that had been previously dissolved by zoning type, and a neighbor table was generated. From this, a zoning classification was assigned to each roadway based on the zoning type of the largest area bordering each road.</p>
          <!--p><code>Maybe Put some code here</code></p-->
          <p>A little bit of manual cleaning of boundaries, and the data is ready for conversion. Converting ESRI shapefiles to geojson is easy using OSGEO in the command prompt</p>
          <p><code>$ ogr2ogr -f GeoJSON -t_srs crs:84 [name].geojson [name].shp</code></p>
          <p>The GeoJSON can then be dragged into <a href="http://www.mapshaper.org/">MapShaper</a> to be simplified and exported as a TopoJSON, which is much small and loads faster in web pages.</p>


        </section>

          <section role="tabpanel1" aria-hidden="true" class="content" id="Data4">
          <h3>Displaying the data on the web</h3><hr>
          <p><a href="http://d3js.org/">D3</a> is an incredibly powerful library for displaying data &#45; particularly spatial data. </p>
          <pre class="prettyprint">
            //Width and height
            var width = 800;
            var height = 650;


            //temporary empty color that will be used for mouseover and mouseout events
            var tempColor;

            //zoom behavior
            var maxZoomIn = 6,
              maxZoomOut = 1;

            //Define the map projection
            var projection = d3.geo.mercator()
                .scale(297838.7704891906)
                .center([-91.53614830925925,41.65676282716673]) //projection center
                .translate([width/2,height/2]) //translate to center the map in view

            //zoom behavior
            var zoom = d3.behavior.zoom()
              .translate(projection.translate())
              .scale(projection)
              .scaleExtent([maxZoomOut, maxZoomIn])
              .on("zoom", zoomed);


            //Define path generator
            var path = d3.geo.path()
              .projection(projection);

            //Create an SVG and append to #map div
            var svg = d3.select("#map").append("svg")
                .attr("width", width)
                .attr("height", height);

            //Generate paths based on projection
            var path = d3.geo.path().projection(projection);


            //Group for the map features
            var features = svg.append("g")
                .attr("class","features");

            //Create zoom/pan listener
            var zoom = d3.behavior.zoom().scaleExtent([1, 4]).on("zoom",zoomed);

            svg.call(zoom);

            //queue data so it loads better
            queue()
              .defer(d3.json, "FoodTrucks_data/Employment.topojson")
              .defer(d3.json, "FoodTrucks_data/OpArea.topojson")
              .await(makeMap);

            //D3 callback for generating the actualy map features and appending them to the features goup
            function makeMap(error, Emp, OpArea){

              //group variable to zoom behavior works correctly
              var group = svg.append('g')
                .attr('id','mapzoom')

              var Emp = group.append('g').attr("id","Emp")
                .selectAll("path")
                  .data(topojson.feature(Emp, Emp.objects.collection).features)//generate features from topoJSON
                  .enter()
                  .append("path")
                  .attr("d", path)
                  .attr("class","Emp")
                .attr("fill", function(d){
                  if (d.properties.Classes <= 3) {
                    color = '#2892C7'
                  } else if (d.properties.Classes == 4){
                    color = '#A0C29B'
                  } else if (d.properties.Classes == 5){
                    color = '#FAFA64'
                  } else if (d.properties.Classes == 6){
                    color = '#FA8D34'
                  } else {
                    color = '#E81014'
                  }
                  return color
                })
                  .style("stroke-width","0.5px")
                  .style("opacity", 0.70);

              var OpArea = group.append('g').attr("id","OpArea")
                .selectAll("path")
                  .data(topojson.feature(OpArea, OpArea.objects.collection).features)//generate features from topoJSON
                  .enter()
                  .append("path")
                  .attr("d", path)
                  .attr("class","OpArea")
                .attr("fill", 'rgb(78,78,78)')
                  .style("stroke-width","0.5px")
                  .style("opacity", 0.85);
            };

            //Update map on zoom/pan
            function zoomed() {
             d3.select('#mapzoom').attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")")
                  .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
            }
          </pre>
        </section>

      </div>

    </div>
   </div>

  <footer class="row">
	<div class="large-12 columns text-center">
	  <p>Iowa City • IA</p>
	  <p><a href="mailto:mawwwk@gmail.com">mawwwk@gmail.com</a> •
	    <a href="http://markpooley.github.io/">www.markpooley.github.io</a></p>
	</div>
	</footer>
    <script src="bower_components/foundation/js/foundation/foundation.magellan.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/foundation/js/foundation.min.js"></script>
    <script src="js/app.js"></script>
    <script src="D3\src_code\d3.min.js"></script>
  	<script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
  	<script src="D3\FoodTrucks.js"></script>
    <script>
      $(document).foundation();
    </script>
  </body>
</html>